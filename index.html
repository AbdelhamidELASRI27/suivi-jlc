<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plateforme Suivi Produit JLC</title>
  <style>
    * {
      box-sizing: border-box;
    }
    .popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.popup {
  background: white;
  padding: 2rem;
  border-radius: 15px;
  max-width: 600px;
  width: 90%;
  box-shadow: 0 8px 30px rgba(0,0,0,0.25);
  position: relative;
  animation: fadeIn 0.3s ease;
}

.popup h3 {
  color: #006400;
  margin-top: 0;
}

.popup .close-btn {
  position: absolute;
  top: 0.5rem;
  right: 1rem;
  font-size: 1.5rem;
  color: #aaa;
  cursor: pointer;
}

.popup .close-btn:hover {
  color: #000;
}

@keyframes fadeIn {
  from { transform: scale(0.95); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

    
    .process-flow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 2rem 0;
      padding: 2rem;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      overflow-x: auto;
    }
    
    .secondary-flow {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 1rem 0;
      padding: 1.5rem;
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      overflow-x: auto;
    }
    
    .flow-step {
      min-width: 120px;
      text-align: center;
      padding: 1rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      position: relative;
    }
    
    .flow-step:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      border-color: #006400;
    }
    
    .flow-step.active {
      border-color: #006400;
      background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
    }
    
    .flow-step.secondary {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    }
    
    .step-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    
    .step-title {
      font-weight: 600;
      color: #006400;
      margin-bottom: 0.3rem;
    }
    
    .step-subtitle {
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 0.5rem;
    }
    
    .step-indicator {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ccc;
    }
    
    .step-indicator.has-data {
      background: #28a745;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .flow-arrow {
      font-size: 1.5rem;
      color: #006400;
      margin: 0 0.5rem;
    }
    
    .partie-details {
      margin: 2rem 0;
      padding: 2rem;
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 1px solid #e0e0e0;
    }
    
    .partie-details h4 {
      color: #006400;
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }
    
    .details-content {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }
    
    .detail-card {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      border-left: 4px solid #006400;
    }
    
    .detail-card h5 {
      margin: 0 0 0.5rem 0;
      color: #006400;
    }
    
    .detail-card p {
      margin: 0;
      color: #666;
    }
    
    .table-container {
      margin-top: 1rem;
    }
    
    .table-container.hidden {
      display: none;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f0f4f5 0%, #e8f5e8 100%);
      min-height: 100vh;
    }
    
    header {
      background: linear-gradient(135deg, #006400 0%, #228B22 100%);
      color: white;
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    header h1 {
      margin: 0;
      font-size: 2rem;
      font-weight: 600;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }
    
    .login-box, .form-section, .admin-section {
      max-width: 800px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.1);
      border: 1px solid #e0e0e0;
    }
    
    .form-section h2, .admin-section h2, .login-box h2 {
      color: #006400;
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
      border-bottom: 2px solid #006400;
      padding-bottom: 0.5rem;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #333;
    }
    
    input, select {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #006400;
      box-shadow: 0 0 0 3px rgba(0,100,0,0.1);
    }
    
    button {
      background: linear-gradient(135deg, #006400 0%, #228B22 100%);
      color: white;
      padding: 0.75rem 2rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    button:hover {
      background: linear-gradient(135deg, #228B22 0%, #32CD32 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .hidden {
      display: none;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    th, td {
      border: 1px solid #e0e0e0;
      padding: 1rem;
      text-align: center;
    }
    
    th {
      background: linear-gradient(135deg, #006400 0%, #228B22 100%);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.9rem;
    }
    
    tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    
    tr:hover {
      background-color: #e8f5e8;
    }
    
    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      border: 1px solid #c3e6cb;
      display: none;
    }
    
    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      border: 1px solid #f5c6cb;
      display: none;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border: 1px solid #e0e0e0;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #006400;
      margin-bottom: 0.5rem;
    }
    
    .stat-label {
      color: #666;
      font-size: 0.9rem;
      text-transform: uppercase;
    }
    
    .logout-btn {
      background: #dc3545;
      margin-left: 1rem;
    }
    
    .logout-btn:hover {
      background: #c82333;
    }
    
    .form-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
    }
    
    .reset-btn {
      background: #6c757d;
    }
    
    .reset-btn:hover {
      background: #5a6268;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 0 0.5rem;
      }
      
      .login-box, .form-section, .admin-section {
        margin: 1rem auto;
        padding: 1rem;
      }
      
      .form-actions {
        flex-direction: column;
      }
      
      table {
        font-size: 0.9rem;
      }
      
      th, td {
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="container">
    <h1>Plateforme de Suivi Produit JLC</h1>
  </div>
</header>

<div class="container">
  <div class="login-box" id="loginBox">
    <h2>Connexion Administrateur</h2>
    <div class="error-message" id="loginError"></div>
    <div class="form-group">
      <label for="adminPass">Mot de passe administrateur</label>
      <input type="password" id="adminPass" placeholder="Saisissez le mot de passe">
    </div>
    <button onclick="checkLogin()">Se connecter</button>
  </div>

  <div class="form-section" id="dataForm">
    <h2>Enregistrement des Donn√©es</h2>
    <div class="success-message" id="successMessage"></div>
    <div class="error-message" id="errorMessage"></div>
    
    <form id="productForm">
      <div class="form-group">
        <label for="partie">Partie Prenante *</label>
        <select id="partie" required>
          <option value="">S√©lectionnez une partie prenante</option>
          <option value="Laverie">Laverie</option>
          <option value="S√©chage">S√©chage</option>
          <option value="Pipeline">Pipeline</option>
          <option value="Train">Train</option>
          <option value="APC (Pulpe)">APC (Pulpe)</option>
          <option value="Chargement Navire">Chargement Navire</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="stock">Stock (K TSM) *</label>
        <input type="number" id="stock" min="0" step="0.01" required>
      </div>
      
      <div class="form-group">
        <label for="cd">Concentration Cd (mg/Kg) *</label>
        <input type="number" id="cd" min="0" step="0.01" required>
      </div>
      
      <div class="form-group">
        <label for="responsable">Responsable *</label>
        <input type="text" id="responsable" required>
      </div>
      
      <div class="form-group">
        <label for="date">Date *</label>
        <input type="date" id="date" required>
      </div>
      
      <div class="form-actions">
        <button type="button" class="reset-btn" onclick="resetForm()">R√©initialiser</button>
        <button type="submit">Valider</button>
      </div>
    </form>
  </div>

  <div class="admin-section hidden" id="adminSection">
    <h2>Tableau de Bord Administrateur</h2>
    <div class="form-group" style="margin-top:2rem">
  <label for="graphPartieFilter">Afficher les graphiques pour :</label>
  <select id="graphPartieFilter" onchange="renderCharts()">
    <option value="">-- S√©lectionnez une partie prenante --</option>
    <option value="Laverie">Laverie</option>
    <option value="S√©chage">S√©chage</option>
    <option value="Pipeline">Pipeline</option>
    <option value="Train">Train</option>
    <option value="APC (Pulpe)">APC (Pulpe)</option>
    <option value="Chargement Navire">Chargement Navire</option>
  </select>
</div>
<canvas id="stockChart" height="150"></canvas>
<canvas id="cdChart" height="150" style="margin-top: 2rem;"></canvas>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalEntries">0</div>
        <div class="stat-label">Entr√©es totales</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="avgCd">0</div>
        <div class="stat-label">Cd moyen (mg/Kg)</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalStock">0</div>
        <div class="stat-label">Stock total (K TSM)</div>
      </div>
    </div>
    
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3>Cartographie des Parties Prenantes</h3>
      <button class="logout-btn" onclick="logout()">Se d√©connecter</button>
    </div>
    
    <div class="process-flow">
      <div class="flow-step" data-partie="Extraction" onclick="showPartieData('Extraction')">
        <div class="step-icon">‚õèÔ∏è</div>
        <div class="step-title">Extraction</div>
        <div class="step-subtitle">(4 mines)</div>
        <div class="step-indicator" id="indicator-Extraction"></div>
      </div>
      
      <div class="flow-arrow">‚û§</div>
      
      <div class="flow-step" data-partie="Epierrage" onclick="showPartieData('Epierrage')">
        <div class="step-icon">üîß</div>
        <div class="step-title">Epierrage</div>
        <div class="step-subtitle">(4 mines)</div>
        <div class="step-indicator" id="indicator-Epierrage"></div>
      </div>
      
      <div class="flow-arrow">‚û§</div>
      
      <div class="flow-step" data-partie="Laverie" onclick="showPartieData('Laverie')">
        <div class="step-icon">üßΩ</div>
        <div class="step-title">Laveries</div>
        <div class="step-subtitle">(3 laveries)</div>
        <div class="step-indicator" id="indicator-Laverie"></div>
      </div>
      
      <div class="flow-arrow">‚û§</div>
      
      <div class="flow-step" data-partie="S√©chage" onclick="showPartieData('S√©chage')">
        <div class="step-icon">üå°Ô∏è</div>
        <div class="step-title">S√©chage</div>
        <div class="step-subtitle">Parc humide</div>
        <div class="step-indicator" id="indicator-S√©chage"></div>
      </div>
      
      <div class="flow-arrow">‚û§</div>
      
      <div class="flow-step" data-partie="Train" onclick="showPartieData('Train')">
        <div class="step-icon">üöÇ</div>
        <div class="step-title">Trains</div>
        <div class="step-subtitle">Chargement</div>
        <div class="step-indicator" id="indicator-Train"></div>
      </div>
      
      <div class="flow-arrow">‚û§</div>
      
      <div class="flow-step" data-partie="Chargement Navire" onclick="showPartieData('Chargement Navire')">
        <div class="step-icon">üö¢</div>
        <div class="step-title">Port Casa</div>
        <div class="step-subtitle">Chargement Navire</div>
        <div class="step-indicator" id="indicator-Chargement Navire"></div>
      </div>
    </div>
    
    <div class="secondary-flow">
      <div class="flow-step" data-partie="Pipeline" onclick="showPartieData('Pipeline')">
        <div class="step-icon">üîß</div>
        <div class="step-title">Pipeline</div>
        <div class="step-subtitle">Head Station</div>
        <div class="step-indicator" id="indicator-Pipeline"></div>
      </div>
      
      <div class="flow-arrow">‚û§</div>
      
      <div class="flow-step" data-partie="APC (Pulpe)" onclick="showPartieData('APC (Pulpe)')">
        <div class="step-icon">üè≠</div>
        <div class="step-title">APC</div>
        <div class="step-subtitle">Pulpe</div>
        <div class="step-indicator" id="indicator-APC (Pulpe)"></div>
      </div>
      
      <div class="flow-arrow">‚û§</div>
      
      <div class="flow-step secondary" onclick="showPartieData('Local')">
        <div class="step-icon">üè¢</div>
        <div class="step-title">Local</div>
        <div class="step-subtitle">Sec DWS</div>
      </div>
      
      <div class="flow-arrow">‚û§</div>
      
      <div class="flow-step secondary" onclick="showPartieData('DWS')">
        <div class="step-icon">üîÑ</div>
        <div class="step-title">DWS</div>
        <div class="step-subtitle">Filtration</div>
      </div>
      
      <div class="flow-arrow">‚û§</div>
      
      <div class="flow-step secondary" onclick="showPartieData('Port Jorf')">
        <div class="step-icon">üö¢</div>
        <div class="step-title">Port Jorf</div>
        <div class="step-subtitle">Chargement Navire</div>
      </div>
    </div>
    
    <div class="partie-details" id="partieDetails">
      <h4 id="partieDetailsTitle">S√©lectionnez une partie prenante</h4>
      <div class="details-content" id="partieDetailsContent">
        <p>Cliquez sur une partie prenante dans la cartographie pour voir les donn√©es associ√©es.</p>
      </div>
    </div>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem;">
      <h3>Toutes les Donn√©es</h3>
      <button onclick="toggleTableView()" id="toggleTableBtn">Afficher le tableau</button>
    </div>
    
    <div class="table-container hidden" id="tableContainer">
      <table>
        <thead>
          <tr>
            <th>Partie Prenante</th>
            <th>Stock (K TSM)</th>
            <th>Cd (mg/Kg)</th>
            <th>Responsable</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="dataTable"></tbody>
      </table>
    </div>
    <button onclick="exporterExcel()">Exporter vers Excel</button>

  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<!-- Add Chart.js CDN to <head> -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let stockChartInstance, cdChartInstance;

function renderCharts() {
  const selectedPartie = document.getElementById('graphPartieFilter').value;
  const stockCtx = document.getElementById('stockChart').getContext('2d');
  const cdCtx = document.getElementById('cdChart').getContext('2d');

  const filtered = donnees.filter(d => d.partie === selectedPartie).sort((a,b) => new Date(a.date) - new Date(b.date));

  const labels = filtered.map(d => formatDate(d.date));
  const stockValues = filtered.map(d => d.stock);
  const cdValues = filtered.map(d => d.cd);

  if (stockChartInstance) stockChartInstance.destroy();
  if (cdChartInstance) cdChartInstance.destroy();

  stockChartInstance = new Chart(stockCtx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Stock (K TSM)',
        data: stockValues,
        backgroundColor: 'rgba(0,100,0,0.2)',
        borderColor: '#006400',
        borderWidth: 2,
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      plugins: { title: { display: true, text: `Evolution du stock - ${selectedPartie}` } }
    }
  });

  cdChartInstance = new Chart(cdCtx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Concentration Cd (mg/Kg)',
        data: cdValues,
        backgroundColor: 'rgba(255,165,0,0.2)',
        borderColor: '#FFA500',
        borderWidth: 2,
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      plugins: { title: { display: true, text: `Evolution du Cd - ${selectedPartie}` } }
    }
  });
}
</script>
<script>
 const supabaseUrl = 'https://htdkfnrivusmgwwpirka.supabase.co'; // ‚Üê √† remplacer
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0ZGtmbnJpdnVzbWd3d3BpcmthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0MTg5ODcsImV4cCI6MjA2Nzk5NDk4N30.et4RmPMAl6ovERF9drafjATikXGOVisZhNU2hNuh35I'; // ‚Üê √† remplacer

const supabase = supabase.createClient(supabaseUrl, supabaseKey);
</script> 
<script>
  let donnees = [];

const donneesLocal = localStorage.getItem('donnees');
donnees = donneesLocal ? JSON.parse(donneesLocal) : [];

  
  // Initialisation
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('productForm').addEventListener('submit', function(e) {
      e.preventDefault();
      enregistrerDonnees();
    });
    
    // Gestion de la touche Entr√©e pour la connexion
    document.getElementById('adminPass').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        checkLogin();
      }
    });
  });
  
  async function enregistrerDonnees() {
  const partie = document.getElementById("partie").value;
  const stock = parseFloat(document.getElementById("stock").value);
  const cd = parseFloat(document.getElementById("cd").value);
  const responsable = document.getElementById("responsable").value.trim();
  const date = document.getElementById("date").value;

  if (!partie || !stock || !cd || !responsable || !date) {
    alert("Veuillez remplir tous les champs.");
    return;
  }

  const { data, error } = await supabase
    .from('donnees')
    .insert([{ partie, stock, cd, responsable, date }]);

  if (error) {
    console.error('Erreur Supabase :', error.message);
    alert("‚ùå Une erreur est survenue.");
  } else {
    console.log('‚úÖ Donn√©es enregistr√©es :', data);
    alert("‚úÖ Donn√©es enregistr√©es avec succ√®s !");
  }
}

  function enregistrerDonnees() {
    const partie = document.getElementById("partie").value;
    const stock = parseFloat(document.getElementById("stock").value);
    const cd = parseFloat(document.getElementById("cd").value);
    const responsable = document.getElementById("responsable").value.trim();
    const date = document.getElementById("date").value;

    // Validation
    if (!partie || !stock || !cd || !responsable || !date) {
      showMessage("Veuillez remplir tous les champs obligatoires.", "error");
      return;
    }

    if (stock < 0 || cd < 0) {
      showMessage("Les valeurs num√©riques ne peuvent pas √™tre n√©gatives.", "error");
      return;
    }

    const data = { 
      partie, 
      stock, 
      cd, 
      responsable, 
      date,
      timestamp: new Date().toISOString()
    };
    
    donnees.push(data);
    localStorage.setItem('donnees', JSON.stringify(donnees));

    showMessage("Donn√©es enregistr√©es avec succ√®s ‚úÖ", "success");
    document.getElementById("productForm").reset();
    document.getElementById('date').valueAsDate = new Date();
    
    // Toujours sauvegarder les donn√©es dans le stockage local (simulation)
    console.log("Donn√©es sauvegard√©es:", data);
    console.log("Total des entr√©es:", donnees.length);
  }

  function checkLogin() {
    const pass = document.getElementById("adminPass").value;
    if (pass === "admin123") {
      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("adminSection").classList.remove("hidden");
      document.getElementById("dataForm").classList.add("hidden"); // Masquer le formulaire
      updateStats();
      afficherTable();
      hideMessage("loginError");
    } else {
      showMessage("Mot de passe incorrect ‚ùå", "error", "loginError");
    }
  }

  function logout() {
    document.getElementById("loginBox").classList.remove("hidden");
    document.getElementById("adminSection").classList.add("hidden");
    document.getElementById("dataForm").classList.remove("hidden"); // R√©afficher le formulaire
    document.getElementById("adminPass").value = "";
    hideMessage("loginError");
  }
  
  async function afficherTable() {
  const { data, error } = await supabase
    .from('donnees')
    .select('*')
    .order('date', { ascending: false });

  if (error) {
    console.error('Erreur de chargement:', error.message);
    return;
  }

  const table = document.getElementById("dataTable");
  table.innerHTML = "";

  data.forEach(d => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${d.partie}</td>
      <td>${d.stock.toFixed(2)}</td>
      <td>${d.cd.toFixed(2)}</td>
      <td>${d.responsable}</td>
      <td>${new Date(d.date).toLocaleDateString('fr-FR')}</td>
    `;
    table.appendChild(row);
  });
}


  function afficherTable() {
    const table = document.getElementById("dataTable");
    table.innerHTML = "";
    
    console.log("Affichage table - Nombre de donn√©es:", donnees.length);
    console.log("Donn√©es:", donnees);
    
    if (donnees.length === 0) {
      table.innerHTML = "<tr><td colspan='5' style='text-align: center; color: #666;'>Aucune donn√©e disponible</td></tr>";
      return;
    }
    
    // Tri par date d√©croissante
    const donneesTriees = [...donnees].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    donneesTriees.forEach(d => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${d.partie}</td>
        <td>${parseFloat(d.stock).toFixed(2)}</td>
        <td>${parseFloat(d.cd).toFixed(2)}</td>
        <td>${d.responsable}</td>
        <td>${formatDate(d.date)}</td>
      `;
      table.appendChild(row);
    });
  }

  function updateStats() {
    const totalEntries = donnees.length;
    const totalStock = donnees.reduce((sum, d) => sum + d.stock, 0);
    const avgCd = donnees.length > 0 ? donnees.reduce((sum, d) => sum + d.cd, 0) / donnees.length : 0;
    
    document.getElementById('totalEntries').textContent = totalEntries;
    document.getElementById('totalStock').textContent = totalStock.toFixed(2);
    document.getElementById('avgCd').textContent = avgCd.toFixed(2);
  }

  function resetForm() {
    document.getElementById("productForm").reset();
    document.getElementById('date').valueAsDate = new Date();
    hideMessage("successMessage");
    hideMessage("errorMessage");
  }

  function showMessage(message, type, elementId = null) {
    const messageElement = document.getElementById(elementId || (type === "error" ? "errorMessage" : "successMessage"));
    messageElement.textContent = message;
    messageElement.style.display = "block";
    
    setTimeout(() => {
      hideMessage(elementId || (type === "error" ? "errorMessage" : "successMessage"));
    }, 5000);
  }
  function toggleTableView() {
  const container = document.getElementById("tableContainer");
  const btn = document.getElementById("toggleTableBtn");

  if (container.classList.contains("hidden")) {
    container.classList.remove("hidden");
    btn.textContent = "Masquer le tableau";
    afficherTable(); // Affiche les donn√©es si ce n'est pas d√©j√† fait
  } else {
    container.classList.add("hidden");
    btn.textContent = "Afficher le tableau";
  }
}
function showPartieData(partie) {
  const popupTitle = document.getElementById("popupTitle");
  const popupContent = document.getElementById("popupContent");
  const popupOverlay = document.getElementById("popupOverlay");

  popupTitle.textContent = `Donn√©es pour ${partie}`;

  const donneesFiltrees = donnees.filter(d => d.partie === partie);

  if (donneesFiltrees.length === 0) {
    popupContent.innerHTML = `<p style="color: #999;">Aucune donn√©e disponible pour cette partie prenante.</p>`;
  } else {
    const cardsHTML = donneesFiltrees
      .sort((a, b) => new Date(b.date) - new Date(a.date))
      .map(d => `
        <div style="background:#f8f9fa; border-left: 4px solid #006400; padding:1rem; border-radius:8px; margin-bottom:1rem;">
          <h4 style="margin:0 0 0.5rem;">${formatDate(d.date)}</h4>
          <p><strong>Stock:</strong> ${parseFloat(d.stock).toFixed(2)} K TSM</p>
          <p><strong>Cd:</strong> ${parseFloat(d.cd).toFixed(2)} mg/Kg</p>
          <p><strong>Responsable:</strong> ${d.responsable}</p>
        </div>
      `).join('');

    popupContent.innerHTML = cardsHTML;
  }

  popupOverlay.classList.remove("hidden");
}

function closePopup() {
  document.getElementById("popupOverlay").classList.add("hidden");
}

function mettreAJourIndicateurs() {
  const partiesUniques = [...new Set(donnees.map(d => d.partie))];

  document.querySelectorAll(".step-indicator").forEach(el => {
    el.classList.remove("has-data");
  });

  partiesUniques.forEach(partie => {
    const id = `indicator-${partie}`;
    const el = document.getElementById(id);
    if (el) el.classList.add("has-data");
  });
}


  function hideMessage(elementId) {
    document.getElementById(elementId).style.display = "none";
  }

  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('fr-FR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
  }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  function exporterExcel() {
    if (donnees.length === 0) {
      alert("Aucune donn√©e √† exporter.");
      return;
    }

    const dataToExport = donnees.map(d => ({
      "Partie Prenante": d.partie,
      "Stock (K TSM)": d.stock,
      "Cd (mg/Kg)": d.cd,
      "Responsable": d.responsable,
      "Date": d.date
    }));

    const worksheet = XLSX.utils.json_to_sheet(dataToExport);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Donn√©es");

    XLSX.writeFile(workbook, "donnees_produit_JLC.xlsx");
  }
</script>

<div id="popupOverlay" class="popup-overlay hidden">
  <div class="popup">
    <span class="close-btn" onclick="closePopup()">√ó</span>
    <h3 id="popupTitle">D√©tails</h3>
    <div id="popupContent"></div>
  </div>
</div>

</body>
</html>
